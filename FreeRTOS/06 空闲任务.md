- 空闲任务(Idle任务)的作用之一：释放被删除的任务的内存
	- 空闲任务优先级为0，它不能阻碍用户任务执行
		- 空闲任务的优先级为0，这意味着一旦某个用户的任务变为就绪态，那么空闲任务马上被切换出去，让这个用户任务运行。在这种情况下，我们说用户任务"抢占"(pre-empt)了空闲任务，这是由调度器实现的。
	- 空闲任务要么处于就绪状态，要么处于运行状态，永远不会阻塞

除了上述目的之外，为什么必须要有空闲任务?一个良好的程序，它的任务都是事件驱动的:平时大部分时间处于阻塞状态。有可能我们自己创建的所有任务都无法执行，但是调度器必须能找到一个可以运行的任务:所以，我们要提供空闲任务。在使用vTaskStartScheduler)函数来创建、启动调度器时，这个函数内部会创建空闲任务:

**要注意的是:如果使用vTaskDelete()来删除任务，那么你就要确保空闲任务有机会执行，否则就无法释放被删除任务的内存。**


![[Pasted image 20240910141915.png]]

如果任务函数不经过其他处理，里面不是死循环的话，当任务退出，直接返回时，会返回到右边这个错误函数，这里面就是一个关闭所有中断的死循环，从而使所有的任务都无法再次执行。因为任务能够发生调度能够发生切换是依赖于`tick`中断。

可以在函数内最后一行加上vTaskDelete(NULL);，将任务退出。

--- 
### 任务如何退出？
- 两种方法
	- 自杀
		- vTaskDelete(NULL);
	- 它杀
		- vTaskDelete(handle);

---
收尸（指做一些清理任务），因为任务是动态分配内存的，分配了结构体分配了栈，所以清理就要去释放`TCB`结构体，以及释放栈`stack`
- A杀B： A给B收尸
- B自杀：空闲任务给B收尸

---
### 良好的编程习惯
- 事件驱动
- 延时函数不要用死循环（**即不要用Delay()，要用阻塞态函数vTaskDelay()**）

--- 

空闲任务的钩子函数（Idle Task Hook）是 FreeRTOS 提供的一种机制，允许用户在系统空闲时执行一些自定义代码。要理解这个钩子函数的名称和功能之间的联系，可以从两个方面来理解：**"空闲任务"**和**"钩子函数"**。

### 1. 空闲任务（Idle Task）

FreeRTOS 中的空闲任务是由系统创建并管理的，它在所有用户任务都处于 **Blocked**（阻塞）、**Suspended**（挂起）或 **Waiting**（等待）状态时自动执行。换句话说，空闲任务是系统确保 CPU 始终有任务执行的最后保障。它的主要作用是防止 CPU 进入完全空闲的状态，也可以用于执行一些资源管理的任务，比如内存回收等。
- **功能**：空闲任务的默认功能通常很简单，比如进入低功耗模式、释放被删除任务的堆栈空间等。
- **运行条件**：空闲任务只有在系统中没有其他就绪任务时才会执行。

### 2. 钩子函数（Hook Function）

**钩子函数** 是一种允许用户在特定事件或状态下执行自定义代码的函数。FreeRTOS 提供钩子函数的机制，允许用户在不修改核心代码的情况下插入自定义逻辑。例如，空闲任务钩子函数允许用户在空闲任务运行时执行一些额外的操作。
- **功能**：通过实现空闲任务钩子函数，用户可以在 FreeRTOS 空闲状态时执行一些后台处理工作。
- **名称来源**：`Idle` 表示空闲状态，`Hook` 表示挂钩机制，允许用户把自定义代码挂到空闲任务上，当系统进入空闲任务时执行该代码。

### 3. 空闲任务钩子函数的典型用途

用户可以在空闲任务钩子函数中实现一些轻量级、不占用大量 CPU 资源的功能，比如：
- 进入低功耗模式
- 调试信息输出
- 后台数据处理（前提是不会影响系统实时性）
- 系统监控

### 4. 函数名和功能的联系

- **函数名**：空闲任务钩子函数通常叫做 `vApplicationIdleHook()`。
    
    - `v`：表示返回值为空 (`void`)。
    - `ApplicationIdleHook`：表示这是一个用户应用程序中的空闲任务钩子函数。
- **功能**：当系统进入空闲任务时，FreeRTOS 会自动调用这个函数。开发者可以在 `vApplicationIdleHook()` 中插入一些需要在系统空闲时执行的任务，确保这些操作只会在没有其他任务要执行时运行，不干扰其他实时任务的调度。
    

### 5. 使用方式

要启用空闲任务钩子函数，用户需要在 `FreeRTOSConfig.h` 中定义宏 `configUSE_IDLE_HOOK` 为 `1`，并实现该钩子函数：
```c
void vApplicationIdleHook(void) {
    // 自定义代码，当系统处于空闲状态时执行
}
```

### 总结
空闲任务钩子函数就是一种允许用户在空闲任务执行时插入自定义逻辑的机制。其名称中的 "Idle" 表示这是在系统空闲时运行的任务，而 "Hook" 则表示用户可以钩挂自定义代码到这个机制上。当所有其他任务都阻塞时，空闲任务会执行，并调用这个钩子函数，让用户能够在系统没有其他工作时执行一些辅助任务。

---
### 问：为什么不直接把代码写到空闲任务的函数里面，而是要通过钩子函数

通过钩子函数（Hook Function）而不是直接修改空闲任务函数本身，主要是出于**可维护性**、**灵活性**和**简化开发**的考虑。下面是具体原因：

### 1. **保持内核代码的独立性和可维护性**

- **内核的独立性**：FreeRTOS 内核代码是经过精心设计的、稳定的代码。如果用户直接修改了内核代码（包括空闲任务函数），会打破内核代码的独立性，使得更新或升级 FreeRTOS 内核变得复杂和困难。
- **简化调试与维护**：将自定义代码与内核代码分离可以简化调试和维护工作。这样开发者可以专注于自定义的逻辑，而不必担心修改内核代码时引入不必要的错误。

### 2. **避免内核修改带来的兼容性问题**

- 如果用户修改了内核中的空闲任务函数，那么每次更新或移植 FreeRTOS 内核时，都可能会遇到兼容性问题。不同的 FreeRTOS 版本可能会对空闲任务进行不同的优化或改动，用户修改内核代码后会增加升级时的兼容性风险。
- 钩子函数提供了一种通用接口，不依赖于具体的 FreeRTOS 内核实现，确保在升级或切换内核版本时，自定义逻辑依旧可用。

### 3. **增强灵活性**

- **钩子函数的灵活性**：钩子函数允许用户根据需要定制行为，插入自己的功能而不干扰内核代码。这样用户可以动态地决定是否使用钩子函数、添加什么样的功能，而不必直接修改 FreeRTOS 的内部任务实现。
- **多个钩子函数支持**：在 FreeRTOS 中，除了空闲任务钩子，还有其他钩子函数（比如 Tick Hook）。通过这种机制，用户可以在特定事件（例如系统时钟滴答或任务上下文切换时）执行自定义代码，而不用侵入性地修改内核。

### 4. **保证系统稳定性**

- **最小化核心修改**：FreeRTOS 是一个实时操作系统，其内核经过了长期的优化和调优，保证了任务调度的高效和稳定。如果用户在内核函数中直接插入自定义代码，可能会破坏这些优化，影响系统的稳定性和性能。
- **简化错误定位**：使用钩子函数，可以更容易地控制自定义代码的影响范围。当系统出现问题时，开发者可以直接查看钩子函数中的代码，而不必逐行检查内核代码。

### 5. **降低开发成本**

- **代码复用**：通过钩子函数，开发者可以在不同的项目中复用同样的自定义逻辑，而不需要每次都修改 FreeRTOS 内核。只需要在 `FreeRTOSConfig.h` 中配置宏并实现钩子函数，便可以在多个项目中轻松应用相同的功能。
- **快速开发**：钩子函数机制减少了开发者对内核代码的依赖，使他们能够专注于应用层的功能开发，而不需要花费大量时间理解和修改 FreeRTOS 的内部实现。

### 6. **实现模块化设计**

- **模块化开发**：使用钩子函数能够使代码更加模块化。通过钩子机制，用户的自定义逻辑被清晰地隔离在钩子函数中，不会混淆和污染内核代码。这种模块化设计有助于开发和调试，也使得项目更加易于维护。

### 结论

钩子函数提供了一种安全、灵活的机制，允许用户定制空闲任务等 FreeRTOS 核心任务的行为，而无需修改 FreeRTOS 内核代码。这样可以保持系统的稳定性和可维护性，同时为用户提供了极大的自由度去添加自定义功能。

--- 

**启用调度器**（调用 `vTaskStartScheduler()`）时，FreeRTOS 会**自动创建一个空闲任务**。这个空闲任务是 FreeRTOS 的核心任务之一，作用是在没有其他任务处于就绪状态时执行。具体来说，它会在系统中没有其他高优先级任务可运行的情况下占用 CPU。

### 空闲任务的作用

1. **释放内存**：如果某个任务已经删除了，但其任务控制块（TCB）和堆栈没有立即被释放，空闲任务会负责清理这些资源，确保系统内存被及时回收。
    
2. **进入低功耗模式**：在很多低功耗系统中，空闲任务通常会负责让处理器进入低功耗状态，比如睡眠模式。在空闲任务中，开发者可以通过空闲钩子函数来加入节能逻辑。
    
3. **执行空闲钩子函数**：如果用户配置了空闲钩子函数（`vApplicationIdleHook()`），空闲任务会在每次运行时调用该钩子函数。开发者可以在钩子函数中执行一些低优先级的后台任务。
    

### 为什么创建空闲任务？

空闲任务的优先级是系统中**最低**的，它保证系统总能有一个可运行的任务。通过创建空闲任务，FreeRTOS 确保在没有其他任务可运行时，CPU 不会停滞不前，而是执行一些系统维护操作或进入低功耗模式。

### 总结

空闲任务是调度器启动后自动创建的，它确保 CPU 在没有其他任务需要运行时不会空闲无事可做。通过钩子函数，用户还可以在空闲任务中执行自定义操作或进行资源清理。
